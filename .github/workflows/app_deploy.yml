name: App Deploy (All-in-One)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  AZURE_LOCATION: eastus
  IMAGE_NAME: ai-agent-starter

jobs:
  build-and-deploy:
    name: Build and Deploy to Azure Container Apps
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Log in to Azure
      run: |
        az login --service-principal \
          --username ${{ secrets.AZURE_CLIENT_ID }} \
          --password ${{ secrets.AZURE_CLIENT_SECRET }} \
          --tenant ${{ secrets.AZURE_TENANT_ID }}
        az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Build Docker image
      run: |
        docker build -t ${{ secrets.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} .

    - name: Test Docker image locally
      run: |
        echo "Testing Docker image before pushing to registry..."
        docker run -d --name test-container -p 8989:8989 \
          -e AZURE_PROJECT_ENDPOINT="test" \
          -e MODEL_DEPLOYMENT_NAME="test" \
          ${{ secrets.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
        
        sleep 10
        
        if docker exec test-container curl -f http://localhost:8989/health; then
          echo "‚úÖ Local Docker health check passed"
        else
          echo "‚ùå Local Docker health check failed"
          docker logs test-container
          exit 1
        fi
        
        docker stop test-container
        docker rm test-container

    - name: Log in to Azure Container Registry
      run: |
        az acr login --name ${{ secrets.AZURE_CONTAINER_REGISTRY }}

    - name: Tag and push Docker image
      run: |
        docker tag ${{ secrets.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} \
          ${{ secrets.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
        docker push ${{ secrets.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
        docker push ${{ secrets.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:latest

    - name: Deploy to Azure Container Apps
      uses: azure/container-apps-deploy-action@v1
      with:
        resourceGroup: ${{ secrets.AZURE_RESOURCE_GROUP }}
        containerAppName: ${{ secrets.AZURE_CONTAINER_APP_NAME }}
        imageToDeploy: ${{ secrets.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
        targetPort: 8989
        ingress: external
        environmentVariables: |
          AZURE_PROJECT_ENDPOINT=${{ secrets.AZURE_PROJECT_ENDPOINT }}
          MODEL_DEPLOYMENT_NAME=${{ secrets.MODEL_DEPLOYMENT_NAME }}
          SERVER_HOST=0.0.0.0
          SERVER_PORT=8989

    - name: Get Container App URL
      id: get-url
      run: |
        FQDN=$(az containerapp show \
          --name ${{ secrets.AZURE_CONTAINER_APP_NAME }} \
          --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
          --query properties.configuration.ingress.fqdn \
          --output tsv)
        echo "url=https://$FQDN" >> $GITHUB_OUTPUT
        echo "Container App URL: https://$FQDN"

    - name: Check deployment health
      run: |
        HEALTH_URL="${{ steps.get-url.outputs.url }}/health"
        MAX_RETRIES=10
        RETRY_COUNT=0
        
        echo "Starting health check at: $HEALTH_URL"
        
        while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
          echo "Health check attempt $((RETRY_COUNT + 1))/$MAX_RETRIES..."
          
          if curl -f -s "$HEALTH_URL" > /dev/null 2>&1; then
            echo "‚úÖ Health check passed!"
            exit 0
          fi
          
          RETRY_COUNT=$((RETRY_COUNT + 1))
          SLEEP_TIME=$((RETRY_COUNT * 5))
          
          if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
            echo "Waiting ${SLEEP_TIME}s before retry..."
            sleep $SLEEP_TIME
          fi
        done
        
        echo "‚ùå Health check failed after $MAX_RETRIES attempts"
        exit 1

    - name: Output deployment details
      run: |
        APP_URL="${{ steps.get-url.outputs.url }}"
        PORTAL_URL="https://portal.azure.com/#@/resource/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ secrets.AZURE_RESOURCE_GROUP }}/overview"
        
        echo "## üöÄ Deployment Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Application URL:** $APP_URL" >> $GITHUB_STEP_SUMMARY
        echo "**Health Endpoint:** $APP_URL/health" >> $GITHUB_STEP_SUMMARY
        echo "**API Docs:** $APP_URL/docs" >> $GITHUB_STEP_SUMMARY
        echo "**Azure Portal:** [View Resource Group]($PORTAL_URL)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Quick Links" >> $GITHUB_STEP_SUMMARY
        echo "- [Container App Logs]($PORTAL_URL)" >> $GITHUB_STEP_SUMMARY
        echo "- [Application Insights]($PORTAL_URL)" >> $GITHUB_STEP_SUMMARY
        echo "- [Container Registry]($PORTAL_URL)" >> $GITHUB_STEP_SUMMARY

    - name: Run smoke tests
      run: |
        API_URL="${{ steps.get-url.outputs.url }}"
        
        # Test root endpoint
        curl -f $API_URL || exit 1
        
        # Test agent status
        curl -f $API_URL/agent_status || exit 1
        
        echo "‚úÖ All smoke tests passed!"

    - name: Comment on commit
      continue-on-error: true
      uses: actions/github-script@v7
      with:
        script: |
          const url = '${{ steps.get-url.outputs.url }}'
          github.rest.repos.createCommitComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: context.sha,
            body: `üöÄ **Deployed to Azure Container Apps**\n\n` +
                  `**URL:** ${url}\n` +
                  `**Health:** ${url}/health\n` +
                  `**API Docs:** ${url}/docs\n` +
                  `**Commit:** ${context.sha.substring(0, 7)}`
          })

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: failure()
    environment: production
    
    steps:
    - name: Log in to Azure
      run: |
        az login --service-principal \
          --username ${{ secrets.AZURE_CLIENT_ID }} \
          --password ${{ secrets.AZURE_CLIENT_SECRET }} \
          --tenant ${{ secrets.AZURE_TENANT_ID }}
        az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Get previous revision
      id: previous
      run: |
        PREV_REVISION=$(az containerapp revision list \
          --name ${{ secrets.AZURE_CONTAINER_APP_NAME }} \
          --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
          --query "[?properties.active==\`true\`] | [1].name" \
          --output tsv)
        echo "revision=$PREV_REVISION" >> $GITHUB_OUTPUT

    - name: Rollback to previous revision
      if: steps.previous.outputs.revision != ''
      run: |
        az containerapp revision activate \
          --name ${{ secrets.AZURE_CONTAINER_APP_NAME }} \
          --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
          --revision ${{ steps.previous.outputs.revision }}
        echo "‚èÆÔ∏è Rolled back to revision: ${{ steps.previous.outputs.revision }}"

    - name: Notify rollback
      continue-on-error: true
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.repos.createCommitComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: context.sha,
            body: `‚ö†Ô∏è **Deployment Failed - Rollback Initiated**\n\n` +
                  `Rolled back to previous revision.\n` +
                  `Check workflow logs for details.`
          })

