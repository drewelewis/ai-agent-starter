name: Docker Build

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Docker image tag'
        required: false
        default: 'test'
  pull_request:
    branches: [ main, develop ]

env:
  IMAGE_NAME: ai-agent-starter

jobs:
  build:
    name: Build and Test Docker Image
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      run: |
        TAG="${{ github.event.inputs.tag || format('pr-{0}', github.event.pull_request.number) || 'test' }}"
        echo "Building image: ${{ env.IMAGE_NAME }}:$TAG"
        docker build -t ${{ env.IMAGE_NAME }}:$TAG .

    - name: Test Docker image locally
      run: |
        TAG="${{ github.event.inputs.tag || format('pr-{0}', github.event.pull_request.number) || 'test' }}"
        echo "Testing image: ${{ env.IMAGE_NAME }}:$TAG"
        
        # Start container
        docker run -d --name test-container -p 8989:8989 \
          -e AZURE_PROJECT_ENDPOINT="test" \
          -e MODEL_DEPLOYMENT_NAME="test" \
          ${{ env.IMAGE_NAME }}:$TAG
        
        # Wait for startup
        echo "Waiting for container startup..."
        sleep 15
        
        # Check health endpoint
        MAX_RETRIES=5
        RETRY_COUNT=0
        
        while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
          echo "Health check attempt $((RETRY_COUNT + 1))/$MAX_RETRIES..."
          
          if docker exec test-container curl -f -s http://localhost:8989/health > /dev/null 2>&1; then
            echo "✅ Health check passed!"
            break
          fi
          
          RETRY_COUNT=$((RETRY_COUNT + 1))
          
          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "❌ Health check failed after $MAX_RETRIES attempts"
            echo "Container logs:"
            docker logs test-container
            exit 1
          fi
          
          sleep 5
        done
        
        # Test API endpoints
        echo "Testing API endpoints..."
        docker exec test-container curl -f http://localhost:8989/ || exit 1
        
        # Cleanup
        docker stop test-container
        docker rm test-container
        
        echo "✅ All tests passed!"

    - name: Scan image for vulnerabilities
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.IMAGE_NAME }}:${{ github.event.inputs.tag || format('pr-{0}', github.event.pull_request.number) || 'test' }}
        format: 'table'
        exit-code: '0'
        severity: 'CRITICAL,HIGH'

    - name: Output summary
      run: |
        TAG="${{ github.event.inputs.tag || format('pr-{0}', github.event.pull_request.number) || 'test' }}"
        echo "## ✅ Docker Build Successful" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Image:** ${{ env.IMAGE_NAME }}:$TAG" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** Built and tested locally" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "- To push to ACR: Run **Docker Deploy** workflow" >> $GITHUB_STEP_SUMMARY
        echo "- To deploy to ACA: Run **ACA Deploy** workflow after push" >> $GITHUB_STEP_SUMMARY
