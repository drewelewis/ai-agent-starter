name: Docker Deploy

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Docker image tag to push'
        required: false
        default: 'latest'
      build_first:
        description: 'Build image before pushing?'
        required: true
        type: boolean
        default: true

env:
  IMAGE_NAME: ai-agent-starter

jobs:
  push-to-acr:
    name: Push Docker Image to ACR
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      if: ${{ github.event.inputs.build_first == 'true' }}

    - name: Log in to Azure
      run: |
        az login --service-principal \
          --username ${{ secrets.AZURE_CLIENT_ID }} \
          --password ${{ secrets.AZURE_CLIENT_SECRET }} \
          --tenant ${{ secrets.AZURE_TENANT_ID }}
        az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Build Docker image
      if: ${{ github.event.inputs.build_first == 'true' }}
      run: |
        TAG="${{ github.event.inputs.tag || github.sha }}"
        echo "Building image: ${{ env.IMAGE_NAME }}:$TAG"
        docker build -t ${{ env.IMAGE_NAME }}:$TAG .

    - name: Test Docker image locally
      if: ${{ github.event.inputs.build_first == 'true' }}
      run: |
        TAG="${{ github.event.inputs.tag || github.sha }}"
        echo "Testing image before pushing..."
        
        docker run -d --name test-container -p 8989:8989 \
          -e AZURE_PROJECT_ENDPOINT="test" \
          -e MODEL_DEPLOYMENT_NAME="test" \
          ${{ env.IMAGE_NAME }}:$TAG
        
        sleep 15
        
        if docker exec test-container curl -f -s http://localhost:8989/health > /dev/null 2>&1; then
          echo "âœ… Health check passed"
        else
          echo "âŒ Health check failed"
          docker logs test-container
          exit 1
        fi
        
        docker stop test-container
        docker rm test-container

    - name: Log in to Azure Container Registry
      run: |
        az acr login --name ${{ secrets.AZURE_CONTAINER_REGISTRY }}

    - name: Tag and push to ACR
      run: |
        TAG="${{ github.event.inputs.tag || github.sha }}"
        ACR_IMAGE="${{ secrets.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}"
        
        echo "Tagging and pushing: $ACR_IMAGE:$TAG"
        
        docker tag ${{ env.IMAGE_NAME }}:$TAG $ACR_IMAGE:$TAG
        docker push $ACR_IMAGE:$TAG
        
        # Also tag as latest if this is from main branch or explicit latest tag
        if [ "$TAG" == "latest" ] || [ "${{ github.ref }}" == "refs/heads/main" ]; then
          echo "Also tagging as latest..."
          docker tag $ACR_IMAGE:$TAG $ACR_IMAGE:latest
          docker push $ACR_IMAGE:latest
        fi
        
        echo "âœ… Image pushed to ACR successfully!"
        echo "IMAGE_TAG=$TAG" >> $GITHUB_ENV
        echo "ACR_IMAGE=$ACR_IMAGE" >> $GITHUB_ENV

    - name: Output summary
      run: |
        PORTAL_URL="https://portal.azure.com/#@/resource/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ secrets.AZURE_RESOURCE_GROUP }}/providers/Microsoft.ContainerRegistry/registries/${{ secrets.AZURE_CONTAINER_REGISTRY }}/repository"
        
        echo "## ðŸ³ Docker Image Pushed to ACR" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Image:** ${{ env.ACR_IMAGE }}:${{ env.IMAGE_TAG }}" >> $GITHUB_STEP_SUMMARY
        echo "**Registry:** ${{ secrets.AZURE_CONTAINER_REGISTRY }}.azurecr.io" >> $GITHUB_STEP_SUMMARY
        echo "**Tag:** ${{ env.IMAGE_TAG }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "- View in [Azure Portal]($PORTAL_URL)" >> $GITHUB_STEP_SUMMARY
        echo "- To deploy: Run **ACA Deploy** workflow with tag \`${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Available Tags" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "az acr repository show-tags --name ${{ secrets.AZURE_CONTAINER_REGISTRY }} --repository ${{ env.IMAGE_NAME }} --orderby time_desc --output table" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
